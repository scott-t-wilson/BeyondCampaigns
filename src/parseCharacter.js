const rules = {
    "stats": [
        {
            "id": 1,
            "entityTypeId": 1472902489,
            "key": "STR",
            "name": "Strength",
            "compendiumText": "<p>Strength measures bodily power, athletic training, and the extent to which you can exert raw physical force.</p>\r\n<h4 id=\"StrengthChecks\">Strength Checks</h4>\r\n<p>A Strength check can model any attempt to lift, push, pull, or break something, to force your body through a space, or to otherwise apply brute force to a situation. The Athletics skill reflects aptitude in certain kinds of Strength checks.</p>\r\n<h5 id=\"Athletics\">Athletics</h5>\r\n<p>Your Strength (Athletics) check covers difficult situations you encounter while climbing, jumping, or swimming. Examples include the following activities:</p>\r\n<ul>\r\n<li>You attempt to climb a sheer or slippery cliff, avoid hazards while scaling a wall, or cling to a surface while something is trying to knock you off.</li>\r\n<li>You try to jump an unusually long distance or pull off a stunt midjump.</li>\r\n<li>You struggle to swim or stay afloat in treacherous currents, storm-tossed waves, or areas of thick seaweed. Or another creature tries to push or pull you underwater or otherwise interfere with your swimming.</li>\r\n</ul>\r\n<h5 id=\"OtherStrengthChecks\">Other Strength Checks</h5>\r\n<p>The DM might also call for a Strength check when you try to accomplish tasks like the following:</p>\r\n<ul>\r\n<li>Force open a stuck, locked, or barred door</li>\r\n<li>Break free of bonds</li>\r\n<li>Push through a tunnel that is too small</li>\r\n<li>Hang on to a wagon while being dragged behind it</li>\r\n<li>Tip over a statue</li>\r\n<li>Keep a boulder from rolling</li>\r\n</ul>\r\n<h4 id=\"AttackRollsandDamage\">Attack Rolls and Damage</h4>\r\n<p>You add your Strength modifier to your attack roll and your damage roll when attacking with a melee weapon such as a mace, a battleaxe, or a javelin. You use melee weapons to make melee attacks in hand-to-hand combat, and some of them can be thrown to make a ranged attack.</p>\r\n<h4 id=\"LiftingandCarrying\">Lifting and Carrying</h4>\r\n<p>Your Strength score determines the amount of weight you can bear. The following terms define what you can lift or carry.</p>\r\n<p><strong>Carrying Capacity.</strong> Your carrying capacity is your Strength score multiplied by 15. This is the weight (in pounds) that you can carry, which is high enough that most characters don't usually have to worry about it.</p>\r\n<p><strong>Push, Drag, or Lift.</strong> You can push, drag, or lift a weight in pounds up to twice your carrying capacity (or 30 times your Strength score). While pushing or dragging weight in excess of your carrying capacity, your speed drops to 5 feet.</p>\r\n<p><strong>Size and Strength.</strong> Larger creatures can bear more weight, whereas Tiny creatures can carry less. For each size category above Medium, double the creature's carrying capacity and the amount it can push, drag, or lift. For a Tiny creature, halve these weights.</p>\r\n<h4 id=\"VariantEncumbrance\">Variant: Encumbrance</h4>\r\n<p>The rules for lifting and carrying are intentionally simple. Here is a variant if you are looking for more detailed rules for determining how a character is hindered by the weight of equipment. When you use this variant, ignore the Strength column of the Armor table in <a title=\"Armor and Shields\" href=\"https://www.dndbeyond.com/compendium/rules/phb/equipment#ArmorandShields\">chapter 5</a>.</p>\r\n<p>If you carry weight in excess of 5 times your Strength score, you are <strong>encumbered</strong>, which means your speed drops by 10 feet.</p>\r\n<p>If you carry weight in excess of 10 times your Strength score, up to your maximum carrying capacity, you are instead <strong>heavily encumbered</strong>, which means your speed drops by 20 feet and you have disadvantage on ability checks, attack rolls, and saving throws that use Strength, Dexterity, or Constitution.</p>"
        },
        {
            "id": 2,
            "entityTypeId": 1472902489,
            "key": "DEX",
            "name": "Dexterity",
            "compendiumText": "<p>Dexterity measures agility, reflexes, and balance.</p>\r\n<h4 id=\"DexterityChecks\">Dexterity Checks</h4>\r\n<p>A Dexterity check can model any attempt to move nimbly, quickly, or quietly, or to keep from falling on tricky footing. The Acrobatics, Sleight of Hand, and Stealth skills reflect aptitude in certain kinds of Dexterity checks.</p>\r\n<h5 id=\"Acrobatics\">Acrobatics</h5>\r\n<p>Your Dexterity (Acrobatics) check covers your attempt to stay on your feet in a tricky situation, such as when you're trying to run across a sheet of ice, balance on a tightrope, or stay upright on a rocking ship's deck. The DM might also call for a Dexterity (Acrobatics) check to see if you can perform acrobatic stunts, including dives, rolls, somersaults, and flips.</p>\r\n<h5 id=\"SleightofHand\">Sleight of Hand</h5>\r\n<p>Whenever you attempt an act of legerdemain or manual trickery, such as planting something on someone else or concealing an object on your person, make a Dexterity (Sleight of Hand) check. The DM might also call for a Dexterity (Sleight of Hand) check to determine whether you can lift a coin purse off another person or slip something out of another person's pocket.</p>\r\n<h5 id=\"Stealth\">Stealth</h5>\r\n<p>Make a Dexterity (Stealth) check when you attempt to conceal yourself from enemies, slink past guards, slip away without being noticed, or sneak up on someone without being seen or heard.</p>\r\n<h5 id=\"OtherDexterityChecks\">Other Dexterity Checks</h5>\r\n<p>The DM might call for a Dexterity check when you try to accomplish tasks like the following:</p>\r\n<ul>\r\n<li>Control a heavily laden cart on a steep descent</li>\r\n<li>Steer a chariot around a tight turn</li>\r\n<li>Pick a lock</li>\r\n<li>Disable a trap</li>\r\n<li>Securely tie up a prisoner</li>\r\n<li>Wriggle free of bonds</li>\r\n<li>Play a stringed instrument</li>\r\n<li>Craft a small or detailed object</li>\r\n</ul>\r\n<h4 id=\"AttackRollsandDamage\">Attack Rolls and Damage</h4>\r\n<p>You add your Dexterity modifier to your attack roll and your damage roll when attacking with a ranged weapon, such as a sling or a longbow. You can also add your Dexterity modifier to your attack roll and your damage roll when attacking with a melee weapon that has the finesse property, such as a dagger or a rapier.</p>\r\n<h4 id=\"ArmorClass\">Armor Class</h4>\r\n<p>Depending on the armor you wear, you might add some or all of your Dexterity modifier to your Armor Class, as described in chapter 5, \"<a title=\"Armor and Shields\" href=\"https://www.dndbeyond.com/compendium/rules/phb/equipment#ArmorandShields\">Equipment</a>.\"</p>\r\n<h4 id=\"Initiative\">Initiative</h4>\r\n<p>At the beginning of every combat, you roll initiative by making a Dexterity check. Initiative determines the order of creatures' turns in combat, as described in chapter 9, \"<a title=\"Initiative\" href=\"https://www.dndbeyond.com/compendium/rules/phb/combat#Initiative\">Combat</a>.\"</p>\r\n<blockquote>\r\n<p><strong>HIDING</strong></p>\r\n<p>The DM decides when circumstances are appropriate for hiding. When you try to hide, make a Dexterity (Stealth) check. Until you are discovered or you stop hiding, that check's total is contested by the Wisdom (Perception) check of any creature that actively searches for signs of your presence.</p>\r\n<p>You can't hide from a creature that can see you clearly, and you give away your position if you make noise, such as shouting a warning or knocking over a vase. An invisible creature can always try to hide. Signs of its passage might still be noticed, and it does have to stay quiet.</p>\r\n<p>In combat, most creatures stay alert for signs of danger all around, so if you come out of hiding and approach a creature, it usually sees you. However, under certain circumstances, the DM might allow you to stay hidden as you approach a creature that is distracted, allowing you to gain advantage on an attack roll before you are seen.</p>\r\n<p><strong>Passive Perception.</strong> When you hide, there's a chance someone will notice you even if they aren't searching. To determine whether such a creature notices you, the DM compares your Dexterity (Stealth) check with that creature's passive Wisdom (Perception) score, which equals 10 + the creature's Wisdom modifier, as well as any other bonuses or penalties. If the creature has advantage, add 5. For disadvantage, subtract 5.</p>\r\n<p>For example, if a 1st-level character (with a proficiency bonus of +2) has a Wisdom of 15 (a +2 modifier) and proficiency in Perception, he or she has a passive Wisdom (Perception) of 14.</p>\r\n<p><strong>What Can You See?</strong> One of the main factors in determining whether you can find a hidden creature or object is how well you can see in an area, which might be <strong>lightly</strong> or <strong>heavily obscured&nbsp;</strong>as explained in chapter 8, &ldquo;<a title=\"Vision and Light\" href=\"https://www.dndbeyond.com/compendium/rules/phb/adventuring#VisionandLight\">Adventuring</a>.&rdquo;</p>\r\n</blockquote>"
        },
        {
            "id": 3,
            "entityTypeId": 1472902489,
            "key": "CON",
            "name": "Constitution",
            "compendiumText": "<p>Constitution measures health, stamina, and vital force.</p>\r\n<h4 id=\"ConstitutionChecks\">Constitution Checks</h4>\r\n<p>Constitution checks are uncommon, and no skills apply to Constitution checks, because the endurance this ability represents is largely passive rather than involving a specific effort on the part of a character or monster. A Constitution check can model your attempt to push beyond normal limits, however.</p>\r\n<p>The DM might call for a Constitution check when you try to accomplish tasks like the following:</p>\r\n<ul>\r\n<li>Hold your breath</li>\r\n<li>March or labor for hours without rest</li>\r\n<li>Go without sleep</li>\r\n<li>Survive without food or water</li>\r\n<li>Quaff an entire stein of ale in one go</li>\r\n</ul>\r\n<h4 id=\"HitPoints\">Hit Points</h4>\r\n<p>Your Constitution modifier contributes to your hit points. Typically, you add your Constitution modifier to each Hit Die you roll for your hit points.</p>\r\n<p>If your Constitution modifier changes, your hit point maximum changes as well, as though you had the new modifier from 1st level. For example, if you raise your Constitution score when you reach 4th level and your Constitution modifier increases from +1 to +2, you adjust your hit point maximum as though the modifier had always been +2. So you add 3 hit points for your first three levels, and then roll your hit points for 4th level using your new modifier. Or if you're 7th level and some effect lowers your Constitution score so as to reduce your Constitution modifier by 1, your hit point maximum is reduced by 7.</p>"
        },
        {
            "id": 4,
            "entityTypeId": 1472902489,
            "key": "INT",
            "name": "Intelligence",
            "compendiumText": "<p>Intelligence measures mental acuity, accuracy of recall, and the ability to reason.</p>\r\n<h4 id=\"IntelligenceChecks\">Intelligence Checks</h4>\r\n<p>An Intelligence check comes into play when you need to draw on logic, education, memory, or deductive reasoning. The Arcana, History, Investigation, Nature, and Religion skills reflect aptitude in certain kinds of Intelligence checks.</p>\r\n<h5 id=\"Arcana\">Arcana</h5>\r\n<p>Your Intelligence (Arcana) check measures your ability to recall lore about spells, magic items, eldritch symbols, magical traditions, the planes of existence, and the inhabitants of those planes.</p>\r\n<h5 id=\"History\">History</h5>\r\n<p>Your Intelligence (History) check measures your ability to recall lore about historical events, legendary people, ancient kingdoms, past disputes, recent wars, and lost civilizations.</p>\r\n<h5 id=\"Investigation\">Investigation</h5>\r\n<p>When you look around for clues and make deductions based on those clues, you make an Intelligence (Investigation) check. You might deduce the location of a hidden object, discern from the appearance of a wound what kind of weapon dealt it, or determine the weakest point in a tunnel that could cause it to collapse. Poring through ancient scrolls in search of a hidden fragment of knowledge might also call for an Intelligence (Investigation) check.</p>\r\n<h5 id=\"Nature\">Nature</h5>\r\n<p>Your Intelligence (Nature) check measures your ability to recall lore about terrain, plants and animals, the weather, and natural cycles.</p>\r\n<h5 id=\"Religion\">Religion</h5>\r\n<p>Your Intelligence (Religion) check measures your ability to recall lore about deities, rites and prayers, religious hierarchies, holy symbols, and the practices of secret cults.</p>\r\n<h5 id=\"OtherIntelligenceChecks\">Other Intelligence Checks</h5>\r\n<p>The DM might call for an Intelligence check when you try to accomplish tasks like the following:</p>\r\n<ul>\r\n<li>Communicate with a creature without using words</li>\r\n<li>Estimate the value of a precious item</li>\r\n<li>Pull together a disguise to pass as a city guard</li>\r\n<li>Forge a document</li>\r\n<li>Recall lore about a craft or trade</li>\r\n<li>Win a game of skill</li>\r\n</ul>\r\n<h4 id=\"SpellcastingAbility\">Spellcasting Ability</h4>\r\n<p>Wizards use Intelligence as their spellcasting ability, which helps determine the saving throw DCs of spells they cast.</p>"
        },
        {
            "id": 5,
            "entityTypeId": 1472902489,
            "key": "WIS",
            "name": "Wisdom",
            "compendiumText": "<p>Wisdom reflects how attuned you are to the world around you and represents perceptiveness and intuition.</p>\r\n<h4 id=\"WisdomChecks\">Wisdom Checks</h4>\r\n<p>A Wisdom check might reflect an effort to read body language, understand someone’s feelings, notice things about the environment, or care for an injured person. The Animal Handling, Insight, Medicine, Perception, and Survival skills reflect aptitude in certain kinds of Wisdom checks.</p>\r\n<h5 id=\"AnimalHandling\">Animal Handling</h5>\r\n<p>When there is any question whether you can calm down a domesticated animal, keep a mount from getting spooked, or intuit an animal’s intentions, the DM might call for a Wisdom (Animal Handling) check. You also make a Wisdom (Animal Handling) check to control your mount when you attempt a risky maneuver.</p>\r\n<h5 id=\"Insight\">Insight</h5>\r\n<p>Your Wisdom (Insight) check decides whether you can determine the true intentions of a creature, such as when searching out a lie or predicting someone’s next move. Doing so involves gleaning clues from body language, speech habits, and changes in mannerisms.</p>\r\n<h5 id=\"Medicine\">Medicine</h5>\r\n<p>A Wisdom (Medicine) check lets you try to stabilize a dying companion or diagnose an illness.</p>\r\n<h5 id=\"Perception\">Perception</h5>\r\n<p>Your Wisdom (Perception) check lets you spot, hear, or otherwise detect the presence of something. It measures your general awareness of your surroundings and the keenness of your senses. For example, you might try to hear a conversation through a closed door, eavesdrop under an open window, or hear monsters moving stealthily in the forest. Or you might try to spot things that are obscured or easy to miss, whether they are orcs lying in ambush on a road, thugs hiding in the shadows of an alley, or candlelight under a closed secret door.</p>\r\n<aside>\r\n<blockquote>\r\n<p id=\"finding-a-hidden-object\"><strong>FINDING A HIDDEN OBJECT</strong></p>\r\n<p>When your character searches for a hidden object such as a secret door or a trap, the DM typically asks you to make a Wisdom (Perception) check. Such a check can be used to find hidden details or other information and clues that you might otherwise overlook.</p>\r\n<p>In most cases, you need to describe where you are looking in order for the DM to determine your chance of success. For example, a key is hidden beneath a set of folded clothes in the top drawer of a bureau. If you tell the DM that you pace around the room, looking at the walls and furniture for clues, you have no chance of finding the key, regardless of your Wisdom (Perception) check result. You would have to specify that you were opening the drawers or searching the bureau in order to have any chance of success.</p>\r\n</blockquote>\r\n</aside>\r\n<h5 id=\"Survival\">Survival</h5>\r\n<p>The DM might ask you to make a Wisdom (Survival) check to follow tracks, hunt wild game, guide your group through frozen wastelands, identify signs that owlbears live nearby, predict the weather, or avoid quicksand and other natural hazards.</p>\r\n<h5 id=\"OtherWisdomChecks\">Other Wisdom Checks</h5>\r\n<p>The DM might call for a Wisdom check when you try to accomplish tasks like the following:</p>\r\n<ul>\r\n<li>Get a gut feeling about what course of action to follow</li>\r\n<li>Discern whether a seemingly dead or living creature is undead</li>\r\n</ul>\r\n<h4 id=\"SpellcastingAbility\">Spellcasting Ability</h4>\r\n<p>Clerics, druids, and rangers use Wisdom as their spellcasting ability, which helps determine the saving throw DCs of spells they cast.</p>"
        },
        {
            "id": 6,
            "entityTypeId": 1472902489,
            "key": "CHA",
            "name": "Charisma",
            "compendiumText": "<p>Charisma measures your ability to interact effectively with others. It includes such factors as confidence and eloquence, and it can represent a charming or commanding personality.</p>\r\n<h4 id=\"CharismaChecks\">Charisma Checks</h4>\r\n<p>A Charisma check might arise when you try to influence or entertain others, when you try to make an impression or tell a convincing lie, or when you are navigating a tricky social situation. The Deception, Intimidation, Performance, and Persuasion skills reflect aptitude in certain kinds of Charisma checks.</p>\r\n<h5 id=\"Deception\">Deception</h5>\r\n<p>Your Charisma (Deception) check determines whether you can convincingly hide the truth, either verbally or through your actions. This deception can encompass everything from misleading others through ambiguity to telling outright lies. Typical situations include trying to fast-talk a guard, con a merchant, earn money through gambling, pass yourself off in a disguise, dull someone's suspicions with false assurances, or maintain a straight face while telling a blatant lie.</p>\r\n<h5 id=\"Intimidation\">Intimidation</h5>\r\n<p>When you attempt to influence someone through overt threats, hostile actions, and physical violence, the DM might ask you to make a Charisma (Intimidation) check. Examples include trying to pry information out of a prisoner, convincing street thugs to back down from a confrontation, or using the edge of a broken bottle to convince a sneering vizier to reconsider a decision.</p>\r\n<h5 id=\"Performance\">Performance</h5>\r\n<p>Your Charisma (Performance) check determines how well you can delight an audience with music, dance, acting, storytelling, or some other form of entertainment.</p>\r\n<h5 id=\"Persuasion\">Persuasion</h5>\r\n<p>When you attempt to influence someone or a group of people with tact, social graces, or good nature, the DM might ask you to make a Charisma (Persuasion) check. Typically, you use persuasion when acting in good faith, to foster friendships, make cordial requests, or exhibit proper etiquette. Examples of persuading others include convincing a chamberlain to let your party see the king, negotiating peace between warring tribes, or inspiring a crowd of townsfolk.</p>\r\n<h5 id=\"OtherCharismaChecks\">Other Charisma Checks</h5>\r\n<p>The DM might call for a Charisma check when you try to accomplish tasks like the following:</p>\r\n<ul>\r\n<li>Find the best person to talk to for news, rumors, and gossip</li>\r\n<li>Blend into a crowd to get the sense of key topics of conversation</li>\r\n</ul>\r\n<h4 id=\"SpellcastingAbility\">Spellcasting Ability</h4>\r\n<p>Bards, paladins, sorcerers, and warlocks use Charisma as their spellcasting ability, which helps determine the saving throw DCs of spells they cast.</p>"
        }
    ],
    "statModifiers": [
        {
            "value": 1,
            "modifier": -5
        },
        {
            "value": 2,
            "modifier": -4
        },
        {
            "value": 3,
            "modifier": -4
        },
        {
            "value": 4,
            "modifier": -3
        },
        {
            "value": 5,
            "modifier": -3
        },
        {
            "value": 6,
            "modifier": -2
        },
        {
            "value": 7,
            "modifier": -2
        },
        {
            "value": 8,
            "modifier": -1
        },
        {
            "value": 9,
            "modifier": -1
        },
        {
            "value": 10,
            "modifier": 0
        },
        {
            "value": 11,
            "modifier": 0
        },
        {
            "value": 12,
            "modifier": 1
        },
        {
            "value": 13,
            "modifier": 1
        },
        {
            "value": 14,
            "modifier": 2
        },
        {
            "value": 15,
            "modifier": 2
        },
        {
            "value": 16,
            "modifier": 3
        },
        {
            "value": 17,
            "modifier": 3
        },
        {
            "value": 18,
            "modifier": 4
        },
        {
            "value": 19,
            "modifier": 4
        },
        {
            "value": 20,
            "modifier": 5
        },
        {
            "value": 21,
            "modifier": 5
        },
        {
            "value": 22,
            "modifier": 6
        },
        {
            "value": 23,
            "modifier": 6
        },
        {
            "value": 24,
            "modifier": 7
        },
        {
            "value": 25,
            "modifier": 7
        },
        {
            "value": 26,
            "modifier": 8
        },
        {
            "value": 27,
            "modifier": 8
        },
        {
            "value": 28,
            "modifier": 9
        },
        {
            "value": 29,
            "modifier": 9
        },
        {
            "value": 30,
            "modifier": 10
        }
    ],
    "levelProficiencyBonuses": [
        {
            "level": 1,
            "bonus": 2
        },
        {
            "level": 2,
            "bonus": 2
        },
        {
            "level": 3,
            "bonus": 2
        },
        {
            "level": 4,
            "bonus": 2
        },
        {
            "level": 5,
            "bonus": 3
        },
        {
            "level": 6,
            "bonus": 3
        },
        {
            "level": 7,
            "bonus": 3
        },
        {
            "level": 8,
            "bonus": 3
        },
        {
            "level": 9,
            "bonus": 4
        },
        {
            "level": 10,
            "bonus": 4
        },
        {
            "level": 11,
            "bonus": 4
        },
        {
            "level": 12,
            "bonus": 4
        },
        {
            "level": 13,
            "bonus": 5
        },
        {
            "level": 14,
            "bonus": 5
        },
        {
            "level": 15,
            "bonus": 5
        },
        {
            "level": 16,
            "bonus": 5
        },
        {
            "level": 17,
            "bonus": 6
        },
        {
            "level": 18,
            "bonus": 6
        },
        {
            "level": 19,
            "bonus": 6
        },
        {
            "level": 20,
            "bonus": 6
        }
    ],
    "abilitySkills": [
        {
            "id": 2,
            "entityTypeId": 1958004211,
            "stat": 1,
            "name": "Athletics",
            "description": "<p>Your Strength (Athletics) check covers difficult situations you encounter while climbing, jumping, or swimming. Examples include the following activities:</p>\r\n<ul>\r\n<li>You attempt to climb a sheer or slippery cliff, avoid hazards while scaling a wall, or cling to a surface while something is trying to knock you off.</li>\r\n<li>You try to jump an unusually long distance or pull off a stunt midjump.</li>\r\n<li>You struggle to swim or stay afloat in treacherous currents, storm-tossed waves, or areas of thick seaweed. Or another creature tries to push or pull you underwater or otherwise interfere with your swimming.</li>\r\n</ul>"
        },
        {
            "id": 3,
            "entityTypeId": 1958004211,
            "stat": 2,
            "name": "Acrobatics",
            "description": "<p>Your Dexterity (Acrobatics) check covers your attempt to stay on your feet in a tricky situation, such as when you're trying to run across a sheet of ice, balance on a tightrope, or stay upright on a rocking ship's deck. The GM might also call for a Dexterity (Acrobatics) check to see if you can perform acrobatic stunts, including dives, rolls, somersaults, and flips.</p>"
        },
        {
            "id": 4,
            "entityTypeId": 1958004211,
            "stat": 2,
            "name": "Sleight of Hand",
            "description": "<p>Whenever you attempt an act of legerdemain or manual trickery, such as planting something on someone else or concealing an object on your person, make a Dexterity (Sleight of Hand) check. The GM might also call for a Dexterity (Sleight of Hand) check to determine whether you can lift a coin purse off another person or slip something out of another person's pocket.</p>\r\n"
        },
        {
            "id": 5,
            "entityTypeId": 1958004211,
            "stat": 2,
            "name": "Stealth",
            "description": "<p>Make a Dexterity (Stealth) check when you attempt to conceal yourself from enemies, slink past guards, slip away without being noticed, or sneak up on someone without being seen or heard.</p>"
        },
        {
            "id": 6,
            "entityTypeId": 1958004211,
            "stat": 4,
            "name": "Arcana",
            "description": "<p>Your Intelligence (Arcana) check measures your ability to recall lore about spells, magic items, eldritch symbols, magical traditions, the planes of existence, and the inhabitants of those planes.</p>"
        },
        {
            "id": 7,
            "entityTypeId": 1958004211,
            "stat": 4,
            "name": "History",
            "description": "<p>Your Intelligence (History) check measures your ability to recall lore about historical events, legendary people, ancient kingdoms, past disputes, recent wars, and lost civilizations.</p>"
        },
        {
            "id": 8,
            "entityTypeId": 1958004211,
            "stat": 4,
            "name": "Investigation",
            "description": "<p>When you look around for clues and make deductions based on those clues, you make an Intelligence (Investigation) check. You might deduce the location of a hidden object, discern from the appearance of a wound what kind of weapon dealt it, or determine the weakest point in a tunnel that could cause it to collapse. Poring through ancient scrolls in search of a hidden fragment of knowledge might also call for an Intelligence (Investigation) check.</p>\r\n"
        },
        {
            "id": 9,
            "entityTypeId": 1958004211,
            "stat": 4,
            "name": "Nature",
            "description": "<p>Your Intelligence (Nature) check measures your ability to recall lore about terrain, plants and animals, the weather, and natural cycles.</p>"
        },
        {
            "id": 10,
            "entityTypeId": 1958004211,
            "stat": 4,
            "name": "Religion",
            "description": "<p>Your Intelligence (Religion) check measures your ability to recall lore about deities, rites and prayers, religious hierarchies, holy symbols, and the practices of secret cults.</p>"
        },
        {
            "id": 11,
            "entityTypeId": 1958004211,
            "stat": 5,
            "name": "Animal Handling",
            "description": "<p>When there is any question whether you can calm down a domesticated animal, keep a mount from getting spooked, or intuit an animal&rsquo;s intentions, the GM might call for a Wisdom (Animal Handling) check. You also make a Wisdom (Animal Handling) check to control your mount when you attempt a risky maneuver.</p>"
        },
        {
            "id": 12,
            "entityTypeId": 1958004211,
            "stat": 5,
            "name": "Insight",
            "description": "<p>Your Wisdom (Insight) check decides whether you can determine the true intentions of a creature, such as when searching out a lie or predicting someone&rsquo;s next move. Doing so involves gleaning clues from body language, speech habits, and changes in mannerisms.</p>\r\n"
        },
        {
            "id": 13,
            "entityTypeId": 1958004211,
            "stat": 5,
            "name": "Medicine",
            "description": "<p>A Wisdom (Medicine) check lets you try to stabilize a dying companion or diagnose an illness.</p>"
        },
        {
            "id": 14,
            "entityTypeId": 1958004211,
            "stat": 5,
            "name": "Perception",
            "description": "<p>Your Wisdom (Perception) check lets you spot, hear, or otherwise detect the presence of something. It measures your general awareness of your surroundings and the keenness of your senses. For example, you might try to hear a conversation through a closed door, eavesdrop under an open window, or hear monsters moving stealthily in the forest. Or you might try to spot things that are obscured or easy to miss, whether they are orcs lying in ambush on a road, thugs hiding in the shadows of an alley, or candlelight under a closed secret door.</p>\r\n"
        },
        {
            "id": 15,
            "entityTypeId": 1958004211,
            "stat": 5,
            "name": "Survival",
            "description": "<p>The GM might ask you to make a Wisdom (Survival) check to follow tracks, hunt wild game, guide your group through frozen wastelands, identify signs that owlbears live nearby, predict the weather, or avoid quicksand and other natural hazards.</p>"
        },
        {
            "id": 16,
            "entityTypeId": 1958004211,
            "stat": 6,
            "name": "Deception",
            "description": "<p>Your Charisma (Deception) check determines whether you can convincingly hide the truth, either verbally or through your actions. This deception can encompass everything from misleading others through ambiguity to telling outright lies. Typical situations include trying to fast-talk a guard, con a merchant, earn money through gambling, pass yourself off in a disguise, dull someone's suspicions with false assurances, or maintain a straight face while telling a blatant lie.</p>\r\n"
        },
        {
            "id": 17,
            "entityTypeId": 1958004211,
            "stat": 6,
            "name": "Intimidation",
            "description": "<p>When you attempt to influence someone through overt threats, hostile actions, and physical violence, the GM might ask you to make a Charisma (Intimidation) check. Examples include trying to pry information out of a prisoner, convincing street thugs to back down from a confrontation, or using the edge of a broken bottle to convince a sneering vizier to reconsider a decision.</p>\r\n"
        },
        {
            "id": 18,
            "entityTypeId": 1958004211,
            "stat": 6,
            "name": "Performance",
            "description": "<p>Your Charisma (Performance) check determines how well you can delight an audience with music, dance, acting, storytelling, or some other form of entertainment.</p>"
        },
        {
            "id": 19,
            "entityTypeId": 1958004211,
            "stat": 6,
            "name": "Persuasion",
            "description": "<p>When you attempt to influence someone or a group of people with tact, social graces, or good nature, the GM might ask you to make a Charisma (Persuasion) check. Typically, you use persuasion when acting in good faith, to foster friendships, make cordial requests, or exhibit proper etiquette. Examples of persuading others include convincing a chamberlain to let your party see the king, negotiating peace between warring tribes, or inspiring a crowd of townsfolk.</p>\r\n"
        }
    ],
};

//
// Returns object:
// {
//     finalArmorClass: 5,
//     baseArmorClass: 10,  // Equal to the type of armor worn, or 10
//     dexModifer: 0,  // Characters dex mod, unless its negated by some other rule
//     unarmoredModifier: 0,  // This will include natural armor or class mod, whichever is higher
//     shieldModifier: 0, // 2 or 0, I think
//     armorType: 0, // 1-3: light, medium, heavy- defined in rules.armorTypes
//     stealthAdjustment: "Disadvantage", // usually disadvantage for heavy, blank otherwise
//     isUnarmored: true,
// }
//
function getArmor(c_json, c, modifiers) {
    let armor = {
        finalArmorClass: null,
        baseArmorClass: 10,  // Equal to the type of armor worn, or 10
        dexModifer: c.stats["dex"].modifier,  // Characters dex mod, unless its negated by some other rule
        unarmoredModifier: 0,  // This will include natural armor or class mod, whichever is higher
        shieldModifier: 0, // 2 or 0, I think
        armorType: 0, // 1-3: light, medium, heavy- defined in rules.armorTypes
        stealthAdjustment: "", // usually disadvantage for heavy, blank otherwise
        isUnarmored: true,
    }

    // Assume that if they have mage armor, they've cast it
    if (c.spells.some(({ name }) => name === 'Mage Armor')) {
        armor.baseArmorClass = 13;
    }

    // Cap dex bonus- this goes along with natural armor
    filterModifiers(modifiers, undefined, "set", "ac-max-dex-modifier").forEach(mod => {
        if (mod.value < armor.dexModifer) {
            armor.dexModifer = mod.value;
        }
    });

    // If they have 'Unarmored Defense', add con mod
    filterModifiers(modifiers, undefined, "set", "unarmored-armor-class").forEach(mod => {
        // This covers barabarian and monk 'Unarmored Defense', adding con or wis
        if (mod.detail.statId != null) {
            let stat_key = ruleStatForID(mod.detail.statId).key.toLowerCase();
            if (armor.unarmoredModifier < c.stats[stat_key].modifier) {
                armor.unarmoredModifier = c.stats[stat_key].modifier;
            }
        }
        // This works with natural armor (tested on Tortle), but need to remove dex bonus - above
        if (mod.detail.fixedValue != null) {
            if (armor.unarmoredModifier < mod.detail.fixedValue) {
                armor.unarmoredModifier = mod.detail.fixedValue;
            }
        }
    });

    c_json.inventory.forEach(item => {
        if ((item.definition.canEquip == item.equipped) && (item.definition.canAttune == item.isAttuned)) {
            if (item.definition.armorTypeId) {
                // console.log(item);
                if (item.definition.armorTypeId == 4) { // shield
                    armor.shieldModifier = item.definition.armorClass;
                } else {
                    if(item.definition.armorTypeId == 3){
                         // heavy armor doesn't use a dex bonus
                        armor.dexModifer = 0
                    }
                    if(item.definition.stealthCheck == 2){
                        armor.stealthAdjustment = "Disadvantage";
                    }
                    if (armor.baseArmorClass < item.definition.armorClass) {
                        armor.baseArmorClass = item.definition.armorClass;
                    }
                }
            }
        }
    });
    armor.finalArmorClass = armor.baseArmorClass + armor.dexModifer + armor.unarmoredModifier + armor.shieldModifier;
    return armor;
}

function getModifiers(c_json) {
    let modifiers = [];
    Object.keys(c_json.modifiers).forEach((mod_source) => {
        let mod_array = c_json.modifiers[mod_source];
        mod_array.forEach((mod, source) => {
            modifiers.push({
                source: mod_source,
                type: mod.type,
                subType: mod.subType,
                value: mod.value,
                detail: mod,
            });
            console.log("mod:", mod_source, mod.type, mod.subType, mod.value);
        });
    });
    return modifiers;
}

function getSpells(c_json) {
    let spells = [];
    Object.keys(c_json.spells).forEach((spell_source) => {
        let spell_array = c_json.spells[spell_source];
        if (spell_array) {
            spell_array.forEach((spell_json, source) => {
                let spell = {
                    source: spell_source,
                    name: spell_json.definition.name,
                }
                spells.push(spell);
            });
        }
    });
    return spells;
}
function calculateStat(c_json, c, modifiers, stat_score_name, stat_value) {
    stat_score_name = stat_score_name.toLowerCase();
    let set_value = null;
    let bonus = 0;
    // console.log("Calculate stat:", stat_score_name, stat_value);
    modifiers.forEach(mod => {
        if (mod.subType == stat_score_name) {
            switch (mod.type) {
                case "set":
                    set_value = (set_value < mod.value) ? mod.value : set_value;
                    break;
                case "bonus":
                    bonus += mod.value;
                    break;
                case "half-proficiency":
                    bonus += Math.floor(c.levelProficiencyBonus / 2);
                    break;
                case "proficiency":
                    bonus += c.levelProficiencyBonus;
                    break;
                case "expertise":
                    bonus += c.levelProficiencyBonus * 2;
                    break;
            }
        }
    });
    let final_value = stat_value + bonus;
    if ((set_value != null) && final_value < set_value) {
        final_value = set_value;
    }
    // console.log(`  FINAL: bonus: ${bonus}, set:${set_value} => ${final_value}`);
    return final_value;
}

function characterLevel(c_json) {
    let c_level = 0;
    Object.values(c_json.classes).forEach(c_class => {
        c_level += c_class.level;
    });
    return c_level;
}

function statModifer(stat_value) {
    let stat_modifer = rules.statModifiers.find(r_statMod => {
        if (stat_value == r_statMod.value) {
            return true;
        }
    });
    return stat_modifer.modifier;
}

function levelProficiencyBonuses(level) {
    let profBonus = rules.levelProficiencyBonuses.find(r_statProf => {
        if (level == r_statProf.level) {
            return true;
        }
    });
    return profBonus.bonus;
}

function getSkills(c_json, c, modifiers) {
    // skills[skill_name.toLowerCase()] = {
    //     name: skill_name,
    //     stat: obj.find(".ct-skills__col--stat").text().toLowerCase(),
    //     modifier: obj.find(".ct-skills__col--modifier").text(),
    //     adjustment: adjustment || "",
    // }
    skills = {};
    let jackOfAllTrades = filterModifiers(modifiers, undefined, "half-proficiency", "ability-checks").length >= 1;
    rules.abilitySkills.forEach(r_skill => {
        let r_stat = ruleStatForID(r_skill.stat);
        let skill_name = r_skill.name.toLowerCase().replace(/ /g, "-");
        let skill_stat = r_stat.key.toLowerCase();
        let skill_modifier = c.stats[skill_stat].modifier;
        let skill_adjustment = "";
        // console.dir(filterModifiers(modifiers, undefined, "proficiency", skill_modifier));
        if (filterModifiers(modifiers, undefined, "expertise", skill_name).length) {
            skill_modifier += c.levelProficiencyBonus * 2;
        } else if (filterModifiers(modifiers, undefined, "proficiency", skill_name).length) {
            skill_modifier += c.levelProficiencyBonus;
        } else if (filterModifiers(modifiers, undefined, "half-proficiency", skill_name).length || jackOfAllTrades) {
            skill_modifier += Math.floor(c.levelProficiencyBonus / 2);
        }
        if(skill_name == "stealth"){
            skill_adjustment = c.armor.stealthAdjustment;
        }
        skills[r_skill.name.toLowerCase()] = {
            name: r_skill.name,
            stat: skill_stat,
            modifier: skill_modifier,
            adjustment: skill_adjustment,  // advantage|disadvantage|"",
        };
    });
    return Object.fromEntries(Object.entries(skills).sort())
}

function filterModifiers(modifiers, modifier_source, modifier_type, modifier_subtype) {
    let filtered = modifiers.filter(modifier => {
        if (
            (((modifier_source == undefined) || (modifier_source == modifier.source))) &&
            (((modifier_type == undefined) || (modifier_type == modifier.type))) &&
            (((modifier_subtype == undefined) || (modifier_subtype == modifier.subType)))
        ) {
            return true;
        }
    });
    return filtered;
}

function modifierSubtypes(modifier_type, modifiers) {
    let subTypes = new Set()
    modifiers.forEach(mod => {
        if (mod.type == modifier_type) {
            subTypes.add(mod.subType);
        }
    });
    return Array.from(subTypes);
}

function ruleStatForID(stat_id) {
    let r_stat = rules.stats.find((stat_search_item) => {
        if (stat_search_item.id == stat_id) {
            return true;
        }
    });
    return r_stat;
}

function parseCharacter(c_json) {
    console.log(`\n#### Parsing ${c_json.name} ####`);
    let character = {
        id: c_json.id,
        userId: c_json.userId,
        readonlyUrl: c_json.readonlyUrl,
        name: c_json.name,
        level: null, // TODO:
        race: null, // TODO:
        class: null, // TODO:
        url: `https://www.dndbeyond.com/profile/${c_json.userId}/characters/${c_json.id}`, // full r/w URL
        avatarUrl: "https://www.dndbeyond.com/Content/Skins/Waterdeep/images/characters/default-avatar-builder.png",
        lastUpdate: Date.now(),
        characterLevel: characterLevel(c_json),
        levelProficiencyBonus: levelProficiencyBonuses(characterLevel(c_json)),
    }

    if (c_json.decorations.avatarUrl) {
        let url_matches = c_json.decorations.avatarUrl.match(/(https.*)\?/);
        if (url_matches && url_matches.length >= 1) {
            character.avatarUrl = url_matches[1];
        }
    }


    // Array of modifiers from race/class/items/etc
    let modifiers = getModifiers(c_json);

    // Primary stats eg: str/dex/etc
    character.stats = {};
    Object.values(c_json.stats).forEach(c_stat => {
        let r_stat = ruleStatForID(c_stat.id);
        let stat_key = r_stat.key.toLowerCase();
        let stat_name = r_stat.name;
        let stat_value = calculateStat(c_json, character, modifiers, stat_name + "-score", c_stat.value);
        character.stats[stat_key] = {
            key: stat_key,
            name: stat_name,
            value: stat_value,
            modifier: statModifer(stat_value)
        };
    });

    // HP, I'm currently ignoring overrideHitPoints
    let hp_per_level = character.stats["con"].modifier;
    filterModifiers(modifiers, undefined, undefined, "hit-points-per-level").forEach(mod =>{
        hp_per_level += mod.value;
    });
    let max_hp = c_json.baseHitPoints + (hp_per_level * character.characterLevel);
    let current_hp = max_hp - c_json.removedHitPoints;
    character.health = {
        hp_current: current_hp,
        hp_max: max_hp,
        hp_temp: c_json.temporaryHitPoints,
    };

    // AC and other core stats
    character.spells = getSpells(c_json);
    character.armor = getArmor(c_json, character, modifiers)
    let base_ac = character.armor.finalArmorClass;
    let walk_speed = calculateStat(c_json, character, modifiers, "speed", (c_json.race.weightSpeeds.normal.walk));
    let movement_bonus = calculateStat(c_json, character, modifiers, "unarmored-movement", 0);
    character.core = {
        ac: calculateStat(c_json, character, modifiers, "armor-class", base_ac),
        initiative: calculateStat(c_json, character, modifiers, "initiative", (character.stats["dex"].modifier)),
        speed: walk_speed + movement_bonus,
        languages: modifierSubtypes("language", modifiers).sort(),
    }

    character.skills = getSkills(c_json, character, modifiers);
    // console.dir(character, { breakLength: 120 });
    return character;
}


function deep_compare(a, b) {
    var logs = [];

    function log(log, path) {
        if (path) {
            logs.push(log + ' (path: ' + path + ').');
        } else {
            logs.push(log + '.');
        }
    }

    function analyse(a, b, path) {
        if (a === b) {
            return;
        }
        if ((a instanceof Object) && (b instanceof Object)) {
            if (a.constructor !== b.constructor) {
                log('Entities do not have same constructors', path);
                return;
            }

            for (const key in a) {
                if (a.hasOwnProperty(key)) {
                    if (!b.hasOwnProperty(key)) {
                        log('Property "' + key + '" does not exist in first entity', path);
                        continue;
                    }
                    analyse(a[key], b[key], path ? path + ' -> ' + key : key);
                }
            }
            for (const key in b) {
                if (b.hasOwnProperty(key) && !a.hasOwnProperty(key)) {
                    log('Property "' + key + '" does not exist in second entity', path);
                }
            }
        } else {
            log('Entities are not equal', path);
        }
    }
    analyse(a, b, '');
    return logs;
}

function compareCharacterJSON(c_dom, c_api) {
    // console.log("Character via DOM:", c_dom);
    // console.log("Character via API:", c_api);
    let equal_flag = true;
    let characterProperties = [
        "avatarUrl",
        // "characterLevel",
        // "class",
        "id",
        // "race",
        // "url",  // These will be different, but working. Built from the API it will have userid, DOM will have username
        "core",
        "stats",
        "skills",
        "health",
        // "conditions",
        // "defenses",
        // "saves",
        // "passives"
    ];
    characterProperties.forEach(property_name => {
        let diff = deep_compare(c_dom[property_name], c_api[property_name]);
        if (diff.length) {
            equal_flag = false;
            console.log(`c_dom[${property_name}]:`, c_dom[property_name]);
            console.log(`c_api[${property_name}]:`, c_api[property_name]);
            console.log(`${property_name}:`, diff);
        }
    });
    return equal_flag;
}

module.exports = {
    parseCharacter,
    compareCharacterJSON
};